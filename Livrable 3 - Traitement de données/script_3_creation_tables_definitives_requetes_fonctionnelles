BEGIN;

-- nom de schéma définitif
SET search_path TO psch;

--Création de la table film

CREATE TABLE film (
    id_film INTEGER,
    titre VARCHAR NOT NULL,
    genre VARCHAR,
    duree INTEGER,
    realisateur VARCHAR,
    date_sortie VARCHAR,
    note INTEGER,
    -- La contrainte de clé étrangère
    CONSTRAINT fk_film_titre 
        FOREIGN KEY (id_film) 
        REFERENCES tmp_titre(id_film)
);

-- Remplissage de la table film
INSERT INTO film
(titre, genre, duree, realisateur, date_sortie, note)
SELECT DISTINCT
	titre,
	genre,
	duree,
	realisateur,
	annee_sortie AS date_sortie,
	note_sur_100
FROM TMP_wiki1
where titre is not null
UNION
SELECT DISTINCT
	titre,
	genre,
	duree,
	realisateur,
	annee_sortie AS date_sortie,
	note_sur_100
FROM TMP_wiki2
where titre is not null;
INSERT INTO film
(titre, genre, realisateur)
SELECT DISTINCT
	titre,
	genre,
	realisateur
FROM tmp_programation tp ;

--importer les id_film depuis tmp_titre
UPDATE film f
SET id_film = t.id_film
FROM tmp_titre t
WHERE f.titre = t.titre  ;

--cette seconde partie de la création de la table film s'étant avérée trop difficile, nous avons eu recours à l'aide d'une intelligence artificielle
--il manque certaines IDs dans id_film. 
--script pour générer automatiquement ces IDs manquantes

--drop la contrainte clé étrangère pour id_film
ALTER TABLE film DROP CONSTRAINT fk_film_titre;

-- remplit les IDs vides avec O pour permettre de passer id_film en NOT NULL
UPDATE film SET id_film = 0 WHERE id_film IS NULL;

--crée une contrainte NOT NULL à id_film
ALTER TABLE film ALTER COLUMN id_film SET NOT NULL;

--génère automatiquement de nouvelles IDs lorsqu'elles sont manquantes, en gardant celles déjà insérées grâce à BY DEFAULT
ALTER TABLE film 
ALTER COLUMN id_film ADD GENERATED BY DEFAULT AS IDENTITY;

--crée de nouvelles IDs pour les lignes où id_film = 0 en s'assurant d'éviter les doublons
SELECT setval(pg_get_serial_sequence('film', 'id_film'), MAX(id_film)) FROM film;

--met à jour uniquement les lignes qui ont l'ID temporaire '0', DEFAULT ne risque plus de faire ders doublons
UPDATE film 
SET id_film = DEFAULT 
WHERE id_film = 0;

-- transforme id_film en clé primaire de la table film
ALTER TABLE film 
ADD PRIMARY KEY (id_film);


--Création de la table aire_geographique 

create table aire_geographique
(
	id_aire_geographique INTEGER NOT NULL GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
	commune VARCHAR NOT NULL,
	code_insee VARCHAR NOT NULL,  
	code_departement VARCHAR NOT NULL,
	region INTEGER NOT NULL,
	nom_region VARCHAR,   
	type_rsa VARCHAR,
	nb_foyers INTEGER,
	nb_personnes INTEGER
);

--Remplissage de la table aire_geographique
insert into aire_geographique 
(commune, code_insee, code_departement, region, nom_region, type_rsa,
nb_foyers, nb_personnes)
select distinct 
	a.commune, 
	a.code_insee, 
	a.departement as code_departement, 
	a.region_cnc as region,
	a.region_administrative as nom_region,
	b.type_rsa,
	b.nbr_foyer_rsa as nb_foyers, 
	b.nbr_pers_rsa as nb_personnes
from tmp_cnc a
left join tmp_rsa b on a.commune = b.commune;

--Création de la table utilisateur

create table utilisateur
(
	id_utilisateur INTEGER NOT NULL GENERATED ALWAYS AS IDENTITY PRIMARY KEY
);

--Création de la table cinema 
create table cinema
(
	id_cinema INTEGER NOT NULL GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
	id_aire_geographique INTEGER,
	nom_cinema VARCHAR NOT NULL,
	adresse VARCHAR,
	commune VARCHAR, 
	longitude REAL,
	latitude REAL,
	numero_uu VARCHAR,
	ecrans INTEGER,
	fauteuils INTEGER,
	FOREIGN KEY (id_aire_geographique) REFERENCES aire_geographique(id_aire_geographique)
);

--remplissage de la table "cinema"

INSERT INTO cinema
(nom_cinema, adresse, commune, longitude, latitude, numero_uu, ecrans, fauteuils)
SELECT DISTINCT 
	nom_cinema, 
	adresse, 
	commune,
	longitude,
	latitude,
	n_uu AS numero_uu, 
	ecrans,
	fauteuils
FROM tmp_cnc ; 

--Création de la table séance

create table seance
(
	id_seance INTEGER NOT NULL GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
	id_film INTEGER,
	id_cinema INTEGER,
	titre varchar,
	nom_cinema varchar,
	debut DATE,
	fin DATE,
	ST BOOLEAN,
	version VARCHAR,
	nb_places INTEGER,
	FOREIGN KEY (id_film) REFERENCES film(id_film),
	FOREIGN KEY (id_cinema) REFERENCES cinema(id_cinema)
);
--Remplissage de la table seance
INSERT INTO seance
(titre, nom_cinema, debut, fin, ST, version, nb_places)
SELECT DISTINCT
	titre,
	nom_cinema,
	debut_seance AS debut,
	fin_seance AS fin,
	sous_titres AS ST,
	version_audio AS version,
	nbr_place AS nb_places
FROM TMP_programation ;

-- Creation table fréquentation 

create table frequentation
--notes: FOREIGN KEY ne fonctionne pas tant que cinema n'est pas créé mais cinema a besoin de frequentation pour être créé: problème. table jointe
(
	id_cinema INTEGER,
	nom_cinema varchar,
	adresse_cinema VARCHAR,
	evolution_entrees INTEGER,
	entrees_2021 INTEGER,
	entrees_2022 INTEGER,
	entrees_2023 INTEGER,
	entrees_2024 INTEGER,
	FOREIGN KEY (id_cinema) REFERENCES cinema(id_cinema)
);

-- Remplissage de la table fréquentation 
INSERT INTO frequentation
(nom_cinema, adresse_cinema, evolution_entrees, entrees_2021, entrees_2022, entrees_2023, entrees_2024)
SELECT distinct
	tec.nom_cinema,
	tec.adresse as adresse_cinema,
	tec.evolution_entrees,
	tec.entree_21 AS entrees_2021, 
	tec.entree_22 AS entrees_2022, 
	tc.entree_23 AS entrees_2023,
	tc.entree_24 AS entrees_2024
FROM tmp_cnc tc 
full join tmp_etab_cine tec
on tc.adresse = tec.adresse;

--Création de la table programmation_cinema
create table programmation_cinema

(
	id_cinema INTEGER, 
	nom_cinema VARCHAR, 
	adresse_cinema VARCHAR,
	seances_annuelles INTEGER,
	art_et_essai BOOL,
	nb_films_inedits INTEGER,
	nb_films_programmes INTEGER,
	pdm_fr INTEGER,
	pdm_us INTEGER,
	pdm_ue INTEGER,
	pdm_autres_films INTEGER,
	pdm_art_et_essai INTEGER,
	FOREIGN KEY (id_cinema) REFERENCES cinema(id_cinema)
);


--remplissage de la table programmation_cinema
INSERT INTO programmation_cinema
(nom_cinema, adresse_cinema, seances_annuelles, art_et_essai, nb_films_inedits, nb_films_programmes, pdm_fr, pdm_us, pdm_ue, pdm_autres_films, pdm_art_et_essai)
SELECT DISTINCT 
	nom_cinema,
	adresse as adresse_cinema,
	seances_annuelles,
	art_et_essai, 
	nb_films_inedits,
	nb_films_programmes,
	pdm_films_francais AS pdm_fr,
	pdm_films_americains AS pdm_us,
	pdm_films_europeens AS pdm_ue,
	pdm_autres_films AS pdm_autres_films,
	pdm_films_ae AS pdm_art_et_essai
FROM tmp_cnc ;

COMMIT ;

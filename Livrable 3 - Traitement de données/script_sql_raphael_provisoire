--remplissage des tables jointes

-- D'abord faire les jointures entre les différentes tables de travail (insérer les données pour les différentes sources)

--remplissage de la table jointe tmp_rs

CREATE TABLE TMP_rsa_CNC 
(
	region_cnc int not null,
	nom_region varchar not null, 
	nom_cinema varchar not null,
	adresse varchar,
	code_insee int not null,
	commune varchar not null,
	departement varchar not null,
	n_uu int,
	ecrans int,
	fauteuils int,
	seances int, 
	entree_24 int,
	entree_23 int,
	evolution_entrees int,
	art_et_essai BOOL,
	nb_films_programmes int,
	nb_films_inedits int,
	pdm_films_francais int,
	pdm_films_americains int,
	pdm_films_europeens int,
	pdm_autres_films int,
	pdm_films_ae int,
	latitude real,
	longitude real,
	type_rsa varchar, 
	nbr_foyer_rsa int,
	nbr_pers_rsa int
)

INSERT INTO TMP_rsa_CNC 
(region_cnc, nom_region, nom_cinema, adresse, code_insee, commune, departement, n_uu, ecrans, fauteuils, seances, entree_24, entree_23, 
evolution_entrees, art_et_essai, nb_films_programmes, nb_films_inedits, pdm_films_francais, pdm_films_americains, pdm_films_europeens, pdm_autres_films, pdm_films_ae,
latitude, longitude, type_rsa, nbr_foyer_rsa, nbr_pers_rsa)
SELECT DISTINCT
	a.region_cnc,
	a.nom_cinema,
	a.adresse,
	a.code_insee,
	a.commune,
	a.departement,
	a.n_uu,
	a.situation_geographique,
	a.ecrans,
	a.fauteuils,
	a.seances,
	a.entree_24,
	a.entree_23,
	a.evolution_entrees,
	a.art_et_essai,
	a.nb_films_programmes,
	a.nb_films_inedits,
	a.pdm_films_francais,
	a.pdm_films_americains,
	a.pdm_films_europeens,
	a.pdm_autres_films,
	a.pdm_films_ae,
	a.latitude,
	a.longitude,
	b.entree_22,
	b.entree_21,
	c.type_rsa, 
	c.nbr_foyer_rsa,
	c.nbr_pers_rsa 
FROM TMP_CNC a
LEFT JOIN TMP_etab_cine b on a.region_cnc = b.region_cnc
LEFT JOIN TMP_rsa c on a.commune = c.commune ; 


-- Conseil Eva : Faire les jointures entre la table film remplie à partir de wikidata et la table séance remplie à partir de programmation 

--Depuis TMP_etab_cine



-- remplissage des tables définitives
 

-- remplissage de la table film 
INSERT INTO film 
(titre, genre, duree, realisateur, date_sortie, note)
SELECT DISTINCT 
	titre,
	genre,
	duree,
	realisateur,
	date_sortie,
	note 
FROM TMP_wiki_1 --wikidata 1 et 2 (À FINIR)? 

--remplissage de la table aire_géographique  

INSERT INTO aire_geographique 
(commune, type_rsa, nb_foyers, nb_personnes, region, nom_departement, code_departement)
SELECT DISTINCT 
	commune, 
	type_rsa, 
	nbr_foyer_rsa AS nb_foyers,
	nbr_pers_rsa AS nb_personnes, 
	region_cnc AS region, 
	departement AS nom_departement, 
	code_insee AS code_departement
FROM TMP_rsa_CNC; 

--remplissage de la table fréquentation 

INSERT INTO frequentation 
(evolution_entrees, entrees_2021, entrees_2022, entrees_2023, entrees_2024)
SELECT DISTINCT 
	evolution_entrees,
	entree_21 AS entrees_2021, 
	entree_22 AS entrees_2022, 
	entree_23 AS entrees_2023,
	entree_24 AS entrees_2024 
FROM TMP_rsa_CNC ; 

--remplissage de la table programmation_cinema
INSERT INTO programmation_cinema
(art_et_essai, nb_films_inedits, nb_films_programmes, pdm_fr, pdm_us, pdm_ue, pdm_autres_films, pdm_art_et_essai)
SELECT DISTINCT 
	art_et_essai, 
	nb_films_inedits,
	nb_films_programmes,
	pdm_films_francais AS pdm_fr,
	pdm_films_americains AS pdm_us,
	pdm_films_europeens AS pdm_ue,
	pdm_autres_films AS pdm_autres_films,
	pdm_films_ae AS pdm_art_et_essai
FROM TMP_rsa_CNC ;

--remplissage de la table séance 

INSERT INTO seance
(debut, fin, ST, version, nb_places)
SELECT DISTINCT 
	debut_seance AS debut, 
	fin_seance AS fin, 
	sous_titres AS ST, 
	version_audio AS version, 
	nbr_place AS nb_places
FROM TMP_programmation ; 


--remplissage de la table "cinema"

INSERT INTO cinema
(nom_cinema, adresse, longitude, latitude, numero_uu, ecrans, fauteuils, capacite_totale)
SELECT DISTINCT 
	nom_cinema, 
	adresse, 
	longitude,
	latitude,
	n_uu AS numero_uu, 
	ecrans,
	fauteuils,
	capacite_totale
FROM TMP_rsa_CNC ; 
	


-- !! Remplissage des tables de relation !! (APRÈS AVOIR FAIT LE RESTE)

--Remplissage de la table "cinema_favori"

INSERT INTO cinema_favori
(id_utilisateur, id_cinema)
SELECT 
FROM 
INNER JOIN 

--Remplissage de la table "calendrier"

INSERT INTO calendrier
(id_utilisateur, id_seance)


-- UPDATE : 

--UPDATE sur la table cinéma : 

UPDATE cinema 
SET id_frequentation = 
FROM 
INNER JOIN 
WHERE

UPDATE cinema 
SET id_programmation 
FROM programmation_cinema
INNER JOIN 
WHERE

UPDATE cinema 
SET id_aire_geographique 
FROM 
INNER JOIN 
WHERE


--UPDATE sur la table séance : 

UPDATE seance  
SET id_film 
FROM 
INNER JOIN 
WHERE

UPDATE seance 
SET id_cinema
FROM 
INNER JOIN 
WHERE

--UPDATE sur la table programmation_cinema : 

UPDATE programmation_cinema  
SET id_cinema
FROM 
INNER JOIN 
WHERE

--UPDATE sur la table fréquentation 

UPDATE frequentation   
SET id_cinema
FROM 
INNER JOIN 
WHERE


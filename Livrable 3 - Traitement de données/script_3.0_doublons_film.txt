--Brouillon pour se débarrasser des doublons dans la table film

--tentative de créer la table film en liant les multiples réalisateurs d'un film à une seule film_id. uniquement pour wikidata, à changer
CREATE TABLE IF NOT EXISTS film_realisateurs (titre, realisateur)
AS
SELECT
    titre,
    realisateur
from TMP_wiki1
where titre is not null and realisateur !~ 'Q[^a-z]'
--évite de prendre les données où le nom du réalisateur est remplacé par une ID Wikidata
group by titre, realisateur
UNION
SELECT
    titre,
    realisateur--tentative de créer la table film en liant les multiples réalisateurs d'un film à une seule film_id. uniquement pour wikidata, à changer
CREATE TABLE IF NOT EXISTS film_realisateurs (titre, realisateur)
AS
SELECT
    titre,
    realisateur
from TMP_wiki1
where titre is not null and realisateur !~ 'Q[^a-z]'
--évite de prendre les données où le nom du réalisateur est remplacé par une ID Wikidata
group by titre, realisateur
UNION
SELECT
    titre,
    realisateur
FROM TMP_wiki2
where titre is not null and realisateur !~ 'Q[^a-z]'
group by titre, realisateur;

--ajoute et insère les ids de films à film_realisateurs. NE MARCHE PAS
ALTER TABLE film_realisateurs
ADD id_film integer FOREIGN KEY REFERENCES film(id_film); 


--create table film sans realisateur
create table film
(
	id_film INTEGER NOT NULL GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
	titre VARCHAR NOT NULL,
	genre VARCHAR,
	duree INTEGER,
	date_sortie VARCHAR,
	note INTEGER
);

-- Remplissage de la table film sans realisateur. ATTENTION: a encore le réalisateur de la programmation
INSERT INTO film
(titre, genre, duree, date_sortie, note)
SELECT DISTINCT
	titre,
	genre,
	duree,
	annee_sortie AS date_sortie,
	note_sur_100
FROM TMP_wiki1
where titre is not null
UNION
SELECT DISTINCT
	titre,
	genre,
	duree,
	annee_sortie AS date_sortie,
	note_sur_100
FROM TMP_wiki2
where titre is not null;
INSERT INTO film
(titre, genre)
SELECT DISTINCT
	titre,
	genre,
	realisateur
FROM tmp_programation tp ;


--identifie les doublons
SELECT
    titre,
    COUNT( titre )
FROM
    film f
GROUP BY
    titre
HAVING
    COUNT( titre )> 1
ORDER BY
    titre;

--supprime les doublons. fait une jointure de la table film avec elle-même, puis utilise cette jointure pour la suppression. garde en priorité les valeurs dont les IDs sont plus petites, car elles viennent de l'insert into des données Wikidata et sont donc plus complètes
select *
from film f 
join film b
on f.id_film = b.id_film;

DELETE FROM
    film f
        USING film b
WHERE
    f.id_film > b.id_film
    AND f.titre = b.titre;
FROM TMP_wiki2
where titre is not null and realisateur !~ 'Q[^a-z]'
group by titre, realisateur;


BEGIN ;

SET search_path TO psch;

--supprime la tables si elle existe déjà, pour nos tests

DROP TABLE IF EXISTS tmp_rsa_cnc;

-- Création d'une table jointe pour réunir les données des différents CSV. Cette table servira a créer les tables définitives 
CREATE TABLE tmp_rsa_cnc 
(
	region_cnc INTEGER NOT NULL,
	nom_region VARCHAR NOT NULL, 
	nom_cinema VARCHAR NOT NULL,
	adresse VARCHAR,
	code_insee INTEGER NOT NULL,
	commune varchar NOT NULL,
	departement varchar NOT NULL,
	n_uu INTEGER,
	ecrans INTEGER,
	fauteuils INTEGER,
	seances INTEGER, 
	entree_24 INTEGER,
	entree_23 INTEGER,
	evolution_entrees INTEGER,
	art_et_essai BOOL,
	nb_films_programmes INTEGER,
	nb_films_inedits INTEGER,
	pdm_films_francais INTEGER,
	pdm_films_americains INTEGER,
	pdm_films_europeens INTEGER,
	pdm_autres_films INTEGER,
	pdm_films_ae INTEGER,
	latitude real,
	longitude real,
	type_rsa VARCHAR, 
	nbr_foyer_rsa INTEGER,
	nbr_pers_rsa INTEGER
);

INSERT INTO tmp_rsa_cnc 
(region_cnc, nom_region, nom_cinema, adresse, code_insee, commune, departement, n_uu, ecrans, fauteuils, seances, entree_24, entree_23, 
evolution_entrees, art_et_essai, nb_films_programmes, nb_films_inedits, pdm_films_francais, pdm_films_americains, pdm_films_europeens, pdm_autres_films, pdm_films_ae,
latitude, longitude, type_rsa, nbr_foyer_rsa, nbr_pers_rsa)
SELECT DISTINCT
	a.region_cnc,
	a.nom_cinema,
	a.adresse,
	a.code_insee,
	a.commune,
	a.departement,
	a.n_uu,
	a.situation_geographique,
	a.ecrans,
	a.fauteuils,
	a.seances,
	a.entree_24,
	a.entree_23,
	a.evolution_entrees,
	a.art_et_essai,
	a.nb_films_programmes,
	a.nb_films_inedits,
	a.pdm_films_francais,
	a.pdm_films_americains,
	a.pdm_films_europeens,
	a.pdm_autres_films,
	a.pdm_films_ae,
	a.latitude,
	a.longitude,
	b.entree_22,
	b.entree_21,
	c.type_rsa, 
	c.nbr_foyer_rsa,
	c.nbr_pers_rsa 
FROM tmp_cnc a
LEFT JOIN tmp_etab_cine b on a.region_cnc = b.region_cnc
LEFT JOIN tmp_rsa c on a.commune = c.commune ; 

--(Doute sur LEFT JOIN : vérifier si c'est bien la bonne jointure)
-- Fin du script
COMMIT ;
